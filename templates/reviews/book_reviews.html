{% extends 'base.html' %}
{% load static %}

{% block title %}{{ book.title }} çš„è©•è«– - é–‹å¿ƒæ›¸åº—{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- æ›¸ç±è³‡è¨Šå€ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            {% if book.photo_small %}
                                <img src="{{ book.photo_small.url }}" class="img-fluid rounded" alt="{{ book.title }}">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 120px;">
                                    <span class="text-muted">ç„¡åœ–ç‰‡</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-10">
                            <h4>{{ book.title }}</h4>
                            <p class="text-muted">ä½œè€…ï¼š{{ book.author }} | å‡ºç‰ˆç¤¾ï¼š{{ book.publisher }}</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>å¹³å‡è©•åˆ†</h5>
                                    <div class="d-flex align-items-center">
                                        <span class="h4 text-warning">{{ book.rating_stars }}</span>
                                        <span class="ml-2">{{ book.average_rating|floatformat:1 }} / 5.0</span>
                                        <span class="ml-2 text-muted">({{ book.review_count }} å‰‡è©•è«–)</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <a href="{% url 'books:book' book.id %}" class="btn btn-outline-primary">è¿”å›æ›¸ç±è©³æƒ…</a>
                                    {% if user.is_authenticated %}
                                        <a href="{% url 'reviews:add_review' book.id %}" class="btn btn-success">å¯«è©•è«–</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- è©•åˆ†çµ±è¨ˆ -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h6>è©•åˆ†åˆ†å¸ƒ</h6>
                </div>
                <div class="card-body">
                    {% for rating, count in rating_stats.items %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ rating }}æ˜Ÿ</span>
                            <div class="progress flex-fill mx-2" style="height: 8px;">
                                {% if book.review_count > 0 %}
                                    {% widthratio count book.review_count 100 as percentage %}
                                    <div class="progress-bar bg-warning" style="width: {{ percentage }}%"></div>
                                {% endif %}
                            </div>
                            <span class="text-muted small">{{ count }}</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- è©•è«–åˆ—è¡¨ -->
        <div class="col-md-9">
            <!-- æ’åºé¸é … -->
            <div class="card mb-3">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>{{ reviews|length }} å‰‡è©•è«–</strong></span>
                        <div class="btn-group btn-group-sm">
                            <a href="?sort=newest" class="btn {% if sort_by == 'newest' %}btn-primary{% else %}btn-outline-primary{% endif %}">æœ€æ–°</a>
                            <a href="?sort=oldest" class="btn {% if sort_by == 'oldest' %}btn-primary{% else %}btn-outline-primary{% endif %}">æœ€èˆŠ</a>
                            <a href="?sort=rating_high" class="btn {% if sort_by == 'rating_high' %}btn-primary{% else %}btn-outline-primary{% endif %}">è©•åˆ†é«˜</a>
                            <a href="?sort=rating_low" class="btn {% if sort_by == 'rating_low' %}btn-primary{% else %}btn-outline-primary{% endif %}">è©•åˆ†ä½</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è©•è«–é …ç›® -->
            {% for review in reviews %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <strong>{{ review.user.username }}</strong>
                                    {% if review.is_verified_purchase %}
                                        <span class="badge badge-success ml-2">å·²é©—è­‰è³¼è²·</span>
                                    {% endif %}
                                    <span class="ml-auto text-muted small">{{ review.created_at|date:"Y-m-d H:i" }}</span>
                                </div>
                                
                                <div class="mb-2">
                                    <span class="text-warning">{{ review.rating_stars }}</span>
                                    <span class="ml-2">{{ review.rating }}/5</span>
                                </div>
                                
                                {% if review.title %}
                                    <h6>{{ review.title }}</h6>
                                {% endif %}
                                
                                <p>{{ review.content|linebreaks }}</p>
                                
                                <!-- æœ‰ç”¨æ€§æŠ•ç¥¨ -->
                                {% if user.is_authenticated and user != review.user %}
                                    <div class="helpful-votes mt-2">
                                        <span class="text-muted small">é€™å‰‡è©•è«–å°æ‚¨æœ‰å¹«åŠ©å—ï¼Ÿ</span>
                                        <button class="btn btn-sm btn-outline-success ml-2 helpful-btn" 
                                                data-review-id="{{ review.id }}" data-helpful="true">
                                            ğŸ‘ æœ‰ç”¨ (<span class="helpful-count">{{ review.helpful_votes.filter.is_helpful__count }}</span>)
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger ml-1 helpful-btn" 
                                                data-review-id="{{ review.id }}" data-helpful="false">
                                            ğŸ‘ ç„¡ç”¨ (<span class="unhelpful-count">{{ review.helpful_votes.filter.is_helpful__count }}</span>)
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                            
                            {% if user == review.user %}
                                <div class="ml-3">
                                    <a href="{% url 'reviews:edit_review' review.id %}" class="btn btn-sm btn-outline-primary">ç·¨è¼¯</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <h5 class="text-muted">å°šç„¡è©•è«–</h5>
                        <p class="text-muted">æˆç‚ºç¬¬ä¸€å€‹è©•è«–é€™æœ¬æ›¸çš„äººï¼</p>
                        {% if user.is_authenticated %}
                            <a href="{% url 'reviews:add_review' book.id %}" class="btn btn-primary">å¯«ç¬¬ä¸€å‰‡è©•è«–</a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}

            <!-- åˆ†é  -->
            {% if reviews.has_other_pages %}
                <nav aria-label="è©•è«–åˆ†é ">
                    <ul class="pagination justify-content-center">
                        {% if reviews.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ reviews.previous_page_number }}&sort={{ sort_by }}">ä¸Šä¸€é </a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in reviews.paginator.page_range %}
                            {% if page_num == reviews.number %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_num }}&sort={{ sort_by }}">{{ page_num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if reviews.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ reviews.next_page_number }}&sort={{ sort_by }}">ä¸‹ä¸€é </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // æœ‰ç”¨æ€§æŠ•ç¥¨è™•ç†
    document.querySelectorAll('.helpful-btn').forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.dataset.reviewId;
            const isHelpful = this.dataset.helpful === 'true';
            
            fetch(`{% url 'reviews:toggle_helpful' 0 %}`.replace('0', reviewId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `is_helpful=${isHelpful}`
            })
            .then(response => response.json())
            .then(data => {
                // æ›´æ–°æŠ•ç¥¨æ•¸é‡
                const helpfulCount = this.closest('.helpful-votes').querySelector('.helpful-count');
                const unhelpfulCount = this.closest('.helpful-votes').querySelector('.unhelpful-count');
                
                if (helpfulCount) helpfulCount.textContent = data.helpful_count;
                if (unhelpfulCount) unhelpfulCount.textContent = data.unhelpful_count;
            });
        });
    });
});
</script>
{% endblock %}
